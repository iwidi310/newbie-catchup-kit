name: Apply reviewer feedback with Codex (@codex trigger)
on:
  pull_request_review:
    types: [submitted]

jobs:
  apply_feedback:
    # ç™ºç«æ¡ä»¶:
    #  1) review.state ãŒ commented ã¾ãŸã¯ changes_requested
    #  2) review.body ã« "@codex" ã‚’å«ã‚€
    if: ${{ (github.event.review.state == 'commented' || github.event.review.state == 'changes_requested') && contains(github.event.review.body, '@codex') }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      - name: Set git user for bot
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Setup Node.js (for Codex CLI)
        uses: actions/setup-node@v4
        with:
          node-version: 'latest'

      - name: Install Codex CLI
        run: npm install -g @openai/codex

      - name: Generate patch from review feedback via Codex
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          FEEDBACK_FILE=review.md
          echo "${{ github.event.review.body }}" > "$FEEDBACK_FILE"

          DIFF_FILE=pr.diff
          gh pr diff ${{ github.event.pull_request.number }} > "$DIFF_FILE"

          codex --auto-edit \
            "æ¬¡ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼æŒ‡æ‘˜ã‚’å…¨ã¦åæ˜ ã—ã¦ã‚³ãƒ¼ãƒ‰ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚**dotfiles (.git* ãªã©) ã¯å¤‰æ›´ç¦æ­¢**ã€‚\n\n--- ãƒ¬ãƒ“ãƒ¥ãƒ¼æŒ‡æ‘˜ ---\n$(cat $FEEDBACK_FILE)\n\n--- ç¾åœ¨ã®PRå·®åˆ† ---\n$(cat $DIFF_FILE)"

          rm pr.diff review.md

          # Commit & push only if there are changes
          if [[ -n $(git status --porcelain) ]]; then
            git add .
            git commit -m "chore: address review feedback via Codex ğŸ¤–"
            git push
          fi

      - name: Request reâ€‘review
        run: gh pr edit ${{ github.event.pull_request.number }} --add-reviewer ${{ github.event.review.user.login }}
